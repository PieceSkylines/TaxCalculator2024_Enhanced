<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>โปรแกรมคำนวณภาษีเงินได้บุคคลธรรมดา ปี 2567</title>
    <!-- Meta viewport tag for responsive design -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Load Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- CSS Styles -->
    <link rel="icon" href="favicon.ico">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            font-size: 18px;
        }
        /* Landing Page Styles */
        .landing-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            /* เปลี่ยนสีพื้นหลังเป็นไล่สีฟ้าอ่อน */
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            color: #333333;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .landing-page h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }
        .landing-page p {
            font-size: 1.3rem;
            margin-bottom: 40px;
            max-width: 600px;
        }
        .landing-page button {
            padding: 18px 40px;
            font-size: 1.6rem;
            background-color: #ffffff;
            color: #4a90e2;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-family: 'Kanit', sans-serif; /* เพิ่มฟอนต์ให้ปุ่ม */
        }
        .landing-page button:hover {
            background-color: #e0e0e0;
        }
        /* Container Styles */
        .container {
            max-width: 800px;
            margin: 30px auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-sizing: border-box;
            display: none; /* ซ่อน container โดยเริ่มต้น */
        }
        h1, h2, h3 {
            color: #333333;
            margin: 0 0 20px 0;
        }
        h1 {
            text-align: center;
            font-size: 2.2rem;
            margin-bottom: 30px;
        }
        label {
            display: block;
            margin-top: 20px;
            font-weight: 600;
            color: #555555;
            font-size: 1.1rem;
        }
        input[type="text"], select {
            width: 100%;
            padding: 14px;
            margin-top: 8px;
            border: 1px solid #cccccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1.1rem;
        }
        .info {
            font-size: 1rem;
            color: #777777;
        }
        button {
            margin-top: 30px;
            width: 100%;
            padding: 18px;
            background-color: #007bff;
            color: #ffffff;
            border: none;
            border-radius: 50px;
            font-size: 1.6rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-family: 'Kanit', sans-serif; /* เพิ่มฟอนต์ให้ปุ่ม */
        }
        button:hover {
            background-color: #0056b3;
        }
        .deduction-section {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
        }
        .section-personal {
            background-color: #fef9e7;
        }
        .section-insurance {
            background-color: #e8f8f5;
        }
        .section-investment {
            background-color: #e0f7fa;
        }
        .section-donation {
            background-color: #f9ebea;
        }
        .section-stimulus {
            background-color: #e8daef;
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .navigation-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }
        .navigation-buttons button {
            width: 100%;
            font-family: 'Kanit', sans-serif; /* เพิ่มฟอนต์ให้ปุ่มใน navigation */
        }
        .error {
            color: red;
            font-size: 0.9rem;
            margin-left: 10px;
        }
        input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 1.1rem;
        }
        /* Result Section */
        #result-section {
            display: none;
        }
        #result-section h2 {
            color: #28a745;
            font-size: 2rem;
            margin-top: 0;
        }
        #result-section p {
            font-size: 1.3rem;
            color: #333333;
        }
        #result-section .tax-amount {
            font-size: 2.2rem;
            color: #d9534f;
            font-weight: bold;
        }
        /* Style for Effective Tax Rate */
        #result-section .effective-tax-rate {
            font-size: 2.2rem;
            color: #28a745; /* Green color */
            font-weight: bold;
        }
        /* Gauge Styles */
        .gauge-container {
            margin-top: 30px;
            text-align: center;
        }
        .gauge {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            height: 30px;
        }
        .gauge-fill {
            background-color: #28a745;
            height: 100%;
            text-align: right;
            line-height: 30px;
            color: #fff;
            font-weight: bold;
            padding-right: 10px;
            box-sizing: border-box;
        }
        /* Button to encourage more investment */
        .investment-button {
            margin-top: 20px;
            padding: 15px;
            background-color: #ffc107;
            color: #212529;
            border: none;
            border-radius: 50px;
            font-size: 1.3rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-family: 'Kanit', sans-serif;
        }
        .investment-button:hover {
            background-color: #e0a800;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            padding-top: 100px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            text-align: center;
        }
        .modal-content h2 {
            margin-top: 0;
        }
        .modal-content ul {
            text-align: left;
            padding-left: 20px;
        }
        .modal-content button {
            width: auto;
            padding: 10px 20px;
            font-size: 1.2rem;
            margin-top: 20px;
            border-radius: 50px;
        }
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 20px auto;
            }
            h1 {
                font-size: 2rem;
            }
            button {
                font-size: 1.5rem;
            }
            label {
                font-size: 1rem;
            }
            input[type="text"], select {
                font-size: 1rem;
            }
            .checkbox-group {
                font-size: 1rem;
            }
            .info {
                font-size: 0.9rem;
            }
        }
        @media (max-width: 480px) {
            body {
                font-size: 16px;
            }
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 1.8rem;
            }
            button {
                font-size: 1.3rem;
            }
            .navigation-buttons {
                flex-direction: column;
            }
            .navigation-buttons button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    
    <!-- Landing Page -->
    <div class="landing-page" id="landing-page">
        <h1>ยินดีต้อนรับสู่โปรแกรมคำนวณภาษี ปี 2567</h1>
        <p>เครื่องมือที่ช่วยคุณคำนวณภาษีเงินได้บุคคลธรรมดาอย่างง่ายดายและรวดเร็ว เพียงกรอกข้อมูลไม่กี่ขั้นตอน</p>
        <button onclick="startCalculator()">เริ่มต้นคำนวณ</button>
    </div>

    <!-- Main Container -->
    <div class="container" id="main-container">
        <h1>โปรแกรมคำนวณภาษีเงินได้บุคคลธรรมดา  ปี 2567</h1>

        <!-- Step 1: รายได้ -->
        <div class="step active" id="step-1">
            <h2>ขั้นตอนที่ 1: รายได้</h2>

            <label>เลือกรูปแบบการกรอกข้อมูลรายได้:</label>
            <div class="checkbox-group">
                <input type="checkbox" id="income_type_annual" name="income_type" value="annual">
                <label for="income_type_annual">รายได้รวมทั้งปี</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="income_type_monthly" name="income_type" value="monthly">
                <label for="income_type_monthly">รายได้ต่อเดือน</label>
            </div>
            <div id="income_type_error" class="error"></div>

            <div id="annual_income_section" style="display: none;">
                <label>รายได้ทั้งปีของคุณ (บาท): <span class="error" id="annual_income_error"></span></label>
                <input type="text" id="annual_income" inputmode="decimal">
            </div>

            <div id="monthly_income_section" style="display: none;">
                <label>รายได้ต่อเดือนของคุณ (บาท): <span class="error" id="monthly_income_error"></span></label>
                <input type="text" id="monthly_income" inputmode="decimal">

                <label>โบนัสที่ได้รับในปีนี้ (บาท):</label>
                <input type="text" id="bonus_income" value="0" inputmode="decimal">
            </div>

            <!-- Added "รายได้อื่น ๆ" -->
            <label>รายได้อื่น ๆ (บาท):</label>
            <input type="text" id="other_income" value="0" inputmode="decimal">
            <div class="info">กรุณากรอกเฉพาะตัวเลข สามารถเว้นว่างได้หากไม่มีรายได้อื่น ๆ</div>

            <div class="navigation-buttons">
                <button onclick="nextStep(1)">ถัดไป</button>
            </div>
        </div>

        <!-- Step 2: ค่าใช้จ่าย -->
        <div class="step" id="step-2">
            <h2>ขั้นตอนที่ 2: ค่าใช้จ่าย</h2>
            <p>ค่าใช้จ่ายหักเหมา 50% แต่ไม่เกิน 100,000 บาท จากรายได้รวมของคุณ</p>
            <p>ค่าใช้จ่ายที่หักได้ของคุณคือ: <span id="expense_display">0</span> บาท</p>

            <div class="navigation-buttons">
                <button onclick="prevStep(2)">ย้อนกลับ</button>
                <button onclick="nextStep(2)">ถัดไป</button>
            </div>
        </div>

        <!-- Step 3: ค่าลดหย่อน -->
        <div class="step" id="step-3">
            <h2>ขั้นตอนที่ 3: ค่าลดหย่อน</h2>

            <!-- Part 1: ค่าลดหย่อนภาษีส่วนตัวและครอบครัว -->
            <div class="deduction-section section-personal">
                <h3>1. ค่าลดหย่อนภาษีส่วนตัวและครอบครัว</h3>

                <label>ค่าลดหย่อนส่วนตัว:</label>
                <p>60,000 บาท</p>

                <label>คุณมีคู่สมรสที่ไม่มีรายได้หรือไม่?</label>
                <select id="spouse">
                    <option value="no">ไม่มี</option>
                    <option value="yes">มี</option>
                </select>
                <div class="info">ลดหย่อนได้ 60,000 บาท ถ้าคู่สมรสไม่มีรายได้</div>

                <label>จำนวนบุตรชอบด้วยกฎหมาย:</label>
                <select id="children_own">
                    <!-- Options will be generated by JavaScript -->
                </select>
                <div class="info">ลดหย่อนบุตรชอบด้วยกฎหมายคนละ 30,000 บาท สำหรับบุตรคนที่ 1 และ 60,000 บาท สำหรับบุตรคนที่ 2 ขึ้นไป</div>

                <label>จำนวนบุตรบุญธรรม:</label>
                <select id="children_adopted">
                    <!-- Options will be generated by JavaScript -->
                </select>
                <div class="info">ลดหย่อนบุตรบุญธรรมคนละ 30,000 บาท สูงสุดไม่เกิน 3 คน</div>

                <label>เงินสมทบประกันสังคมที่จ่ายจริง (บาท):</label>
                <input type="text" id="social_security" value="0" inputmode="decimal">
                <span class="error" id="social_security_error"></span>
                <div class="info">ลดหย่อนได้ตามที่จ่ายจริง สูงสุดไม่เกิน 9,000 บาท</div>

                <label>บิดามารดาของคุณที่อายุมากกว่า 60 ปี และมีรายได้ไม่เกิน 30,000 บาทต่อปี:</label>
                <div class="checkbox-group">
                <input type="checkbox" id="your_father">
                <label for="your_father">บิดาของคุณ</label>
                </div>
                <div class="checkbox-group">
                <input type="checkbox" id="your_mother">
                <label for="your_mother">มารดาของคุณ</label>
                </div>
            
                <label>บิดามารดาของคู่สมรสที่อายุมากกว่า 60 ปี และมีรายได้ไม่เกิน 30,000 บาทต่อปี:</label>
                <div class="checkbox-group">
                <input type="checkbox" id="spouse_father">
                <label for="spouse_father">บิดาของคู่สมรส</label>
                </div>
                <div class="checkbox-group">
                <input type="checkbox" id="spouse_mother">
                <label for="spouse_mother">มารดาของคู่สมรส</label>
                </div>

                <label>จำนวนผู้พิการหรือทุพพลภาพที่คุณอุปการะ:</label>
                <select id="disabled_persons">
                    <!-- Options will be generated by JavaScript -->
                </select>
                <div class="info">ลดหย่อนได้คนละ 60,000 บาท</div>
            </div>

            <!-- ส่วนที่เหลือจะแสดงเมื่อผู้ใช้เลือกว่ามีค่าลดหย่อนในส่วนนั้น -->
            <h3>เลือกค่าลดหย่อนเพิ่มเติมที่คุณมี:</h3>
            <div class="checkbox-group">
                <input type="checkbox" id="has_insurance">
                <label for="has_insurance">2. ค่าลดหย่อนภาษีกลุ่มประกัน เงินออม และการลงทุน</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="has_donation">
                <label for="has_donation">3. ค่าลดหย่อนภาษีกลุ่มเงินบริจาค</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="has_stimulus">
                <label for="has_stimulus">4. ค่าลดหย่อนกลุ่มกระตุ้นเศรษฐกิจของรัฐ</label>
            </div>

            <!-- Part 2: ค่าลดหย่อนภาษีกลุ่มประกัน เงินออม และการลงทุน -->
            <div class="deduction-section section-insurance" id="insurance_section" style="display: none;">
                <h3>2. ค่าลดหย่อนภาษีกลุ่มประกัน เงินออม และการลงทุน</h3>

                <label>เบี้ยประกันชีวิตและประกันสะสมทรัพย์ (บาท):</label>
                <input type="text" id="life_insurance" value="0" inputmode="decimal">
                <span class="error" id="life_insurance_error"></span>
                <div class="info">ลดหย่อนได้ตามที่จ่ายจริง สูงสุดไม่เกิน 100,000 บาท</div>

                <label>เบี้ยประกันสุขภาพ (บาท):</label>
                <input type="text" id="health_insurance" value="0" inputmode="decimal">
                <span class="error" id="health_insurance_error"></span>
                <div class="info">ลดหย่อนได้ตามที่จ่ายจริง สูงสุดไม่เกิน 25,000 บาท และเมื่อรวมกับเบี้ยประกันชีวิตต้องไม่เกิน 100,000 บาท</div>

                <label>เบี้ยประกันสุขภาพบิดามารดา (บาท):</label>
                <input type="text" id="parent_health_insurance" value="0" inputmode="decimal">
                <span class="error" id="parent_health_insurance_error"></span>
                <div class="info">ลดหย่อนได้ตามที่จ่ายจริง สูงสุดไม่เกิน 15,000 บาท</div>

                <label>เงินสมทบกองทุนสำรองเลี้ยงชีพ (PVD) (บาท):</label>
                <input type="text" id="pvd" value="0" inputmode="decimal">
                <span class="error" id="pvd_error"></span>
                <div class="info">ลดหย่อนได้ 15% ของเงินได้ สูงสุดไม่เกิน 500,000 บาท</div>

                <label>เบี้ยประกันชีวิตแบบบำนาญ (บาท):</label>
                <input type="text" id="pension_insurance" value="0" inputmode="decimal">
                <span class="error" id="pension_insurance_error"></span>
                <div class="info">ลดหย่อนได้ 15% ของเงินได้ สูงสุดไม่เกิน 200,000 บาท</div>

                <label>กองทุนรวมเพื่อการออม (SSF) (บาท):</label>
                <input type="text" id="ssf" value="0" inputmode="decimal">
                <span class="error" id="ssf_error"></span>
                <div class="info">ลดหย่อนได้ 30% ของเงินได้ สูงสุดไม่เกิน 200,000 บาท</div>

                <label>กองทุนรวมเพื่อการเลี้ยงชีพ (RMF) (บาท):</label>
                <input type="text" id="rmf" value="0" inputmode="decimal">
                <span class="error" id="rmf_error"></span>
                <div class="info">ลดหย่อนได้ 30% ของเงินได้ สูงสุดไม่เกิน 500,000 บาท</div>

                <label>กองทุนรวมไทยเพื่อความยั่งยืน (Thai ESG) (บาท):</label>
                <input type="text" id="thaiesg" value="0" inputmode="decimal">
                <span class="error" id="thaiesg_error"></span>
                <div class="info">ลดหย่อนได้ 30% ของเงินได้ สูงสุดไม่เกิน 300,000 บาท</div>

                <label>เงินลงทุนธุรกิจ Social Enterprise (บาท):</label>
                <input type="text" id="social_enterprise" value="0" inputmode="decimal">
                <span class="error" id="social_enterprise_error"></span>
                <div class="info">ลดหย่อนได้ตามที่จ่ายจริง สูงสุดไม่เกิน 100,000 บาท</div>

                <label>เงินสมทบกองทุนการออมแห่งชาติ (กอช.) (บาท):</label>
                <input type="text" id="nsf" value="0" inputmode="decimal">
                <span class="error" id="nsf_error"></span>
                <div class="info">ลดหย่อนได้ตามที่จ่ายจริง สูงสุดไม่เกิน 13,200 บาท</div>
            </div>
            
            <!-- Part 3: ค่าลดหย่อนภาษีกลุ่มเงินบริจาค -->
            <!-- Created by Suntiphab Vareenitisakul, 3031, WB-PIC -->
            <div class="deduction-section section-donation" id="donation_section" style="display: none;">
                <h3>3. ค่าลดหย่อนภาษีกลุ่มเงินบริจาค</h3>

                <label>เงินบริจาคทั่วไป (บาท):</label>
                <input type="text" id="donation" value="0" inputmode="decimal">
                <span class="error" id="donation_error"></span>
                <div class="info">ลดหย่อนได้ตามที่จ่ายจริง สูงสุดไม่เกิน 10% ของเงินได้หลังหักลดหย่อน</div>

                <label>เงินบริจาคเพื่อการศึกษา กีฬา พัฒนาสังคม และสถานพยาบาลของรัฐ (บาท):</label>
                <input type="text" id="donation_education" value="0" inputmode="decimal">
                <span class="error" id="donation_education_error"></span>
                <div class="info">ลดหย่อนได้ 2 เท่าของเงินบริจาคจริง สูงสุดไม่เกิน 10% ของเงินได้หลังหักลดหย่อน</div>

                <label>เงินบริจาคพรรคการเมือง (บาท):</label>
                <input type="text" id="donation_political" value="0" inputmode="decimal">
                <span class="error" id="donation_political_error"></span>
                <div class="info">ลดหย่อนได้ตามที่จ่ายจริง สูงสุดไม่เกิน 10,000 บาท</div>
            </div>

            <!-- Part 4: ค่าลดหย่อนกลุ่มกระตุ้นเศรษฐกิจของรัฐ -->
            <div class="deduction-section section-stimulus" id="stimulus_section" style="display: none;">
                <h3>4. ค่าลดหย่อนกลุ่มกระตุ้นเศรษฐกิจของรัฐ</h3>

                <label>Easy e-Receipt 2567 (บาท):</label>
                <input type="text" id="easy_ereceipt" value="0" inputmode="decimal">
                <span class="error" id="easy_ereceipt_error"></span>
                <div class="info">ลดหย่อนได้ตามที่จ่ายจริง สูงสุดไม่เกิน 50,000 บาท</div>

                <label>ค่าลดหย่อนเที่ยวเมืองรอง 2567 (บาท):</label>
                <input type="text" id="local_travel" value="0" inputmode="decimal">
                <span class="error" id="local_travel_error"></span>
                <div class="info">ลดหย่อนได้ตามที่จ่ายจริง สูงสุดไม่เกิน 15,000 บาท</div>

                <label>ดอกเบี้ยกู้ยืมเพื่อที่อยู่อาศัย (บาท):</label>
                <input type="text" id="home_loan_interest" value="0" inputmode="decimal">
                <span class="error" id="home_loan_interest_error"></span>
                <div class="info">ลดหย่อนได้ตามที่จ่ายจริง สูงสุดไม่เกิน 100,000 บาท</div>

                <label>ค่าสร้างบ้านใหม่ 2567-2568 (บาท):</label>
                <input type="text" id="new_home" value="0" inputmode="decimal">
                <span class="error" id="new_home_error"></span>
                <div class="info">ลดหย่อนได้ 10,000 บาท ต่อค่าก่อสร้าง 1 ล้านบาท สูงสุดไม่เกิน 100,000 บาท</div>
            </div>

            <div class="navigation-buttons">
                <button onclick="prevStep(3)">ย้อนกลับ</button>
                <button onclick="calculateTax()">คำนวณภาษี</button>
            </div>
        </div>

        <!-- Result Section -->
        <div id="result-section">
            <h2>สรุปผลการคำนวณ</h2>
            <p><strong>รายได้ทั้งปี:</strong> <span id="result_total_income">0</span> บาท</p>
            <p><strong>ค่าใช้จ่ายที่หักได้:</strong> <span id="result_expense">0</span> บาท</p>
            <p><strong>ค่าลดหย่อน:</strong> <span id="result_deductions">0</span> บาท</p>
            <p><strong>เงินได้สุทธิ:</strong> <span id="result_net_income">0</span> บาท</p>
            <p><strong>ภาษีที่ต้องชำระ:</strong> <span class="tax-amount" id="result_tax">0 บาท</span></p>
            <!-- Added Effective Tax Rate with styling -->
            <p><strong>อัตราภาษีที่แท้จริง (Effective Tax Rate):</strong> <span class="effective-tax-rate" id="result_effective_tax_rate">0%</span></p>
            
            <!-- Gauge Section -->
            <div class="gauge-container">
                <h3>การใช้สิทธิลดหย่อนกลุ่มเกษียณ</h3>
                <div class="gauge">
                    <div class="gauge-fill" id="gauge_fill" style="width: 0%;">0%</div>
                </div>
                <!-- Investment Button -->
                <button id="investment_button" class="investment-button" style="display: none;" onclick="goToInvestmentSection()">ซื้อ RMF SSF หรือ ThaiESG เพิ่ม เพื่อลดหย่อนให้มากขึ้น</button>
            </div>

            <div class="navigation-buttons">
                <button onclick="editData()">แก้ไขข้อมูล</button>
                <button onclick="resetData()">เริ่มใหม่</button>
            </div>
        </div>
    </div>

    <!-- Modal for Error Messages -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <h2>พบข้อผิดพลาด</h2>
            <ul id="errorList"></ul>
            <button onclick="closeErrorModal()">รับทราบ</button>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ฟังก์ชันสำหรับเริ่มโปรแกรมคำนวณ
        function startCalculator() {
            document.getElementById('landing-page').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            window.scrollTo(0, 0);
        }

        // ตัวแปรสำหรับเก็บข้อมูล
        let total_income = 0;
        let expense = 0;

        // ฟังก์ชันสำหรับแสดงผลคอมม่าในตัวเลข
        function formatNumber(num) {
            return num.toLocaleString('en-US', {maximumFractionDigits: 2, minimumFractionDigits: 0});
        }

        // ฟังก์ชันสำหรับแปลงสตริงที่มีคอมม่าเป็นตัวเลข
        function parseNumber(str) {
            if (typeof str === 'string') {
                return parseFloat(str.replace(/,/g, '')) || 0;
            }
            return 0;
        }

        // ฟังก์ชันสำหรับเพิ่มคอมม่าขณะกรอกข้อมูล
        function addCommaEvent(id) {
            let input = document.getElementById(id);
            input.addEventListener('input', function(e) {
                let cursorPosition = this.selectionStart;
                let value = this.value.replace(/,/g, '');
                if (value === '') {
                    this.value = '';
                    return;
                }
                // Check if value is a valid number
                if (!isNaN(value)) {
                    let parts = value.split('.');
                    let integerPart = parts[0];
                    let decimalPart = parts[1];

                    // Format the integer part with commas
                    let formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                    let formattedValue = formattedInteger;
                    if (decimalPart !== undefined) {
                        formattedValue += '.' + decimalPart;
                    }
                    this.value = formattedValue;
                    // Adjust cursor position
                    let diff = this.value.length - value.length;
                    this.selectionEnd = cursorPosition + diff;
                } else {
                    this.value = this.value.substring(0, cursorPosition - 1) + this.value.substring(cursorPosition);
                    this.selectionEnd = cursorPosition - 1;
                }
            });
        }

        // เพิ่มคอมม่าขณะกรอกข้อมูลและจัดการการคลิกสำหรับทุกช่อง
        let numberFields = [
            'annual_income', 'monthly_income', 'bonus_income', 'other_income', 'social_security',
            'life_insurance', 'health_insurance', 'parent_health_insurance', 'pension_insurance',
            'ssf', 'rmf', 'pvd', 'thaiesg', 'social_enterprise', 'nsf',
            'home_loan_interest', 'donation', 'donation_education', 'donation_political',
            'easy_ereceipt', 'local_travel', 'new_home'
        ];

        // Add comma event and focus/blur events to number fields
        numberFields.forEach(function(id) {
            addCommaEvent(id);
            let input = document.getElementById(id);

            // Clear the zero when the input gains focus
            input.addEventListener('focus', function() {
                if (this.value === '0') {
                    this.value = '';
                }
            });

            // If the input is empty when it loses focus, reset it to zero
            input.addEventListener('blur', function() {
                if (this.value === '') {
                    this.value = '0';
                }
            });
        });

        // การจัดการการเลือกประเภทของรายได้
        let incomeTypeCheckboxes = document.querySelectorAll('input[name="income_type"]');
        incomeTypeCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                incomeTypeCheckboxes.forEach(function(box) {
                    if (box !== this) {
                        box.checked = false;
                    }
                }, this);

                if (this.value === 'annual' && this.checked) {
                    document.getElementById('annual_income_section').style.display = 'block';
                    document.getElementById('monthly_income_section').style.display = 'none';
                } else if (this.value === 'monthly' && this.checked) {
                    document.getElementById('annual_income_section').style.display = 'none';
                    document.getElementById('monthly_income_section').style.display = 'block';
                } else {
                    document.getElementById('annual_income_section').style.display = 'none';
                    document.getElementById('monthly_income_section').style.display = 'none';
                }
            });
        });

        // ฟังก์ชันสำหรับไปยังขั้นตอนถัดไป
        function nextStep(currentStep) {
            if (currentStep === 1) {
                // ตรวจสอบว่าผู้ใช้เลือกประเภทของรายได้หรือไม่
                let incomeTypeSelected = false;
                let incomeType = '';
                incomeTypeCheckboxes.forEach(function(checkbox) {
                    if (checkbox.checked) {
                        incomeTypeSelected = true;
                        incomeType = checkbox.value;
                    }
                });

                if (!incomeTypeSelected) {
                    document.getElementById('income_type_error').innerText = 'กรุณาเลือกประเภทของรายได้';
                    return;
                } else {
                    document.getElementById('income_type_error').innerText = '';
                }

                // รับข้อมูลรายได้
                if (incomeType === 'annual') {
                    let annual_income = parseNumber(document.getElementById('annual_income').value);
                    if (annual_income === 0) {
                        document.getElementById('annual_income_error').innerText = 'กรุณากรอกรายได้ทั้งปีของคุณ';
                        return;
                    } else {
                        document.getElementById('annual_income_error').innerText = '';
                    }
                    total_income = annual_income;
                } else if (incomeType === 'monthly') {
                    let monthly_income = parseNumber(document.getElementById('monthly_income').value);
                    if (monthly_income === 0) {
                        document.getElementById('monthly_income_error').innerText = 'กรุณากรอกรายได้ต่อเดือนของคุณ';
                        return;
                    } else {
                        document.getElementById('monthly_income_error').innerText = '';
                    }
                    let bonus_income = parseNumber(document.getElementById('bonus_income').value);
                    total_income = (monthly_income * 12) + bonus_income;
                }

                // รับรายได้อื่น ๆ
                let other_income = parseNumber(document.getElementById('other_income').value) || 0;
                total_income += other_income;

                // คำนวณค่าใช้จ่ายหักเหมา 50% แต่ไม่เกิน 100,000 บาท
                expense = total_income * 0.50;
                if (expense > 100000) expense = 100000;

                // แสดงผลค่าใช้จ่ายที่หักได้
                document.getElementById('expense_display').innerText = formatNumber(expense);

                // ไปยังขั้นตอนที่ 2
                document.getElementById('step-1').classList.remove('active');
                document.getElementById('step-2').classList.add('active');
                window.scrollTo(0, 0);
            } else if (currentStep === 2) {
                // ไปยังขั้นตอนที่ 3
                document.getElementById('step-2').classList.remove('active');
                document.getElementById('step-3').classList.add('active');
                window.scrollTo(0, 0);
            }
        }

        // ฟังก์ชันสำหรับย้อนกลับไปยังขั้นตอนก่อนหน้า
        // Created by Suntiphab Vareenitisakul, 3031, WB-PIC
        function prevStep(currentStep) {
            if (currentStep === 2) {
                document.getElementById('step-2').classList.remove('active');
                document.getElementById('step-1').classList.add('active');
                window.scrollTo(0, 0);
            } else if (currentStep === 3) {
                document.getElementById('step-3').classList.remove('active');
                document.getElementById('step-2').classList.add('active');
                window.scrollTo(0, 0);
            }
        }

        // สร้างตัวเลือกจำนวนบุตรใน Dropdown
        function populateChildrenOptions() {
            const childrenOwnSelect = document.getElementById('children_own');
            const childrenAdoptedSelect = document.getElementById('children_adopted');
            const disabledPersonsSelect = document.getElementById('disabled_persons');
            for (let i = 0; i <= 10; i++) {
                const optionOwn = document.createElement('option');
                optionOwn.value = i;
                optionOwn.text = i;
                if (i === 0) {
                    optionOwn.selected = true;
                }
                childrenOwnSelect.add(optionOwn);

                const optionAdopted = document.createElement('option');
                optionAdopted.value = i;
                optionAdopted.text = i;
                if (i === 0) {
                    optionAdopted.selected = true;
                }
                childrenAdoptedSelect.add(optionAdopted);

                const optionDisabled = document.createElement('option');
                optionDisabled.value = i;
                optionDisabled.text = i;
                if (i === 0) {
                    optionDisabled.selected = true;
                }
                disabledPersonsSelect.add(optionDisabled);
            }
        }

        // เรียกใช้ฟังก์ชันเมื่อโหลดหน้าเสร็จ
        window.onload = function() {
            populateChildrenOptions();

            // การแสดงผลส่วนของค่าลดหย่อนเพิ่มเติม
            document.getElementById('has_insurance').addEventListener('change', function() {
                document.getElementById('insurance_section').style.display = this.checked ? 'block' : 'none';
            });
            document.getElementById('has_donation').addEventListener('change', function() {
                document.getElementById('donation_section').style.display = this.checked ? 'block' : 'none';
            });
            document.getElementById('has_stimulus').addEventListener('change', function() {
                document.getElementById('stimulus_section').style.display = this.checked ? 'block' : 'none';
            });
        };

        // ฟังก์ชันสำหรับคำนวณภาษี
        function calculateTax() {
            // ล้างข้อความผิดพลาดก่อนหน้า
            document.querySelectorAll('.error').forEach(function(el) {
                el.innerText = '';
            });

            let errorMessages = [];
            let errorFields = [];

            // ค่าลดหย่อน
            let personal_allowance = 60000;
            let spouse = document.getElementById('spouse').value;
            let spouse_allowance = (spouse === 'yes') ? 60000 : 0;

            // บุตรชอบด้วยกฎหมาย
            let children_own = parseInt(document.getElementById('children_own').value) || 0;
            let child_allowance = 0;
            for (let i = 1; i <= children_own; i++) {
                if (i >= 2) {
                    child_allowance += 60000;
                } else {
                    child_allowance += 30000;
                }
            }

            // บุตรบุญธรรม
            let children_adopted = parseInt(document.getElementById('children_adopted').value) || 0;
            if (children_adopted > 3) children_adopted = 3; // สูงสุดไม่เกิน 3 คน
            child_allowance += children_adopted * 30000;

            // บิดามารดา
            let parents_allowance = 0;
            
            if (document.getElementById('your_father').checked) {
                parents_allowance += 30000;
            }
            if (document.getElementById('your_mother').checked) {
                parents_allowance += 30000;
            }
            if (document.getElementById('spouse_father').checked) {
                parents_allowance += 30000;
            }
            if (document.getElementById('spouse_mother').checked) {
                parents_allowance += 30000;
            }
            
            // สูงสุดไม่เกิน 120,000 บาท
            if (parents_allowance > 120000) parents_allowance = 120000;

            // ผู้พิการหรือทุพพลภาพ
            let disabled_persons = parseInt(document.getElementById('disabled_persons').value) || 0;
            let disabled_allowance = disabled_persons * 60000;

            // เงินสมทบประกันสังคม
            let social_security = parseNumber(document.getElementById('social_security').value);
            if (social_security > 9000) {
                errorMessages.push('เงินสมทบประกันสังคมไม่ควรเกิน 9,000 บาท');
                errorFields.push('social_security');
            }
            social_security = Math.min(social_security, 9000);

            let total_personal_deductions = personal_allowance + spouse_allowance + child_allowance + parents_allowance + disabled_allowance + social_security;

            // ค่าลดหย่อนกลุ่มประกัน เงินออม และการลงทุน
            let total_investment_deductions = 0;
            let retirement_total = 0; // ตัวแปรสำหรับตรวจสอบค่าลดหย่อนกลุ่มเกษียณ
            let max_retirement_deduction = 0;
            if (document.getElementById('has_insurance').checked) {
                let life_insurance = parseNumber(document.getElementById('life_insurance').value);
                if (life_insurance > 100000) {
                    errorMessages.push('เบี้ยประกันชีวิตและประกันสะสมทรัพย์ไม่ควรเกิน 100,000 บาท');
                    errorFields.push('life_insurance');
                }
                life_insurance = Math.min(life_insurance, 100000);

                let health_insurance = parseNumber(document.getElementById('health_insurance').value);
                if (health_insurance > 25000) {
                    errorMessages.push('เบี้ยประกันสุขภาพไม่ควรเกิน 25,000 บาท');
                    errorFields.push('health_insurance');
                }
                health_insurance = Math.min(health_insurance, 25000);

                // รวมประกันชีวิตและสุขภาพ สูงสุดไม่เกิน 100,000 บาท
                let insurance_total = life_insurance + health_insurance;
                if (insurance_total > 100000) {
                    errorMessages.push('รวมเบี้ยประกันชีวิตและสุขภาพไม่ควรเกิน 100,000 บาท');
                    errorFields.push('life_insurance');
                }
                insurance_total = Math.min(insurance_total, 100000);

                let parent_health_insurance = parseNumber(document.getElementById('parent_health_insurance').value);
                if (parent_health_insurance > 15000) {
                    errorMessages.push('เบี้ยประกันสุขภาพบิดามารดาไม่ควรเกิน 15,000 บาท');
                    errorFields.push('parent_health_insurance');
                }
                parent_health_insurance = Math.min(parent_health_insurance, 15000);

                let pension_insurance = parseNumber(document.getElementById('pension_insurance').value);
                let pension_limit = total_income * 0.15;
                if (pension_insurance > pension_limit || pension_insurance > 200000) {
                    errorMessages.push('เบี้ยประกันชีวิตแบบบำนาญไม่ควรเกิน 15% ของรายได้หรือ 200,000 บาท');
                    errorFields.push('pension_insurance');
                }
                pension_insurance = Math.min(pension_insurance, pension_limit, 200000);

                let pvd = parseNumber(document.getElementById('pvd').value);
                let pvd_limit = total_income * 0.15;
                if (pvd > pvd_limit || pvd > 500000) {
                    errorMessages.push('เงินสมทบกองทุนสำรองเลี้ยงชีพ (PVD) ไม่ควรเกิน 15% ของรายได้หรือ 500,000 บาท');
                    errorFields.push('pvd');
                }
                pvd = Math.min(pvd, pvd_limit, 500000);

                let ssf = parseNumber(document.getElementById('ssf').value);
                let ssf_limit = total_income * 0.30;
                if (ssf > ssf_limit || ssf > 200000) {
                    errorMessages.push('กองทุนรวมเพื่อการออม (SSF) ไม่ควรเกิน 30% ของรายได้หรือ 200,000 บาท');
                    errorFields.push('ssf');
                }
                ssf = Math.min(ssf, ssf_limit, 200000);

                let rmf = parseNumber(document.getElementById('rmf').value);
                let rmf_limit = total_income * 0.30;
                if (rmf > rmf_limit || rmf > 500000) {
                    errorMessages.push('กองทุนรวมเพื่อการเลี้ยงชีพ (RMF) ไม่ควรเกิน 30% ของรายได้หรือ 500,000 บาท');
                    errorFields.push('rmf');
                }
                rmf = Math.min(rmf, rmf_limit, 500000);

                let thaiesg = parseNumber(document.getElementById('thaiesg').value);
                let thaiesg_limit = total_income * 0.30;
                if (thaiesg > thaiesg_limit || thaiesg > 300000) {
                    errorMessages.push('กองทุนรวมไทยเพื่อความยั่งยืน (Thai ESG) ไม่ควรเกิน 30% ของรายได้หรือ 300,000 บาท');
                    errorFields.push('thaiesg');
                }
                thaiesg = Math.min(thaiesg, thaiesg_limit, 300000);

                let social_enterprise = parseNumber(document.getElementById('social_enterprise').value);
                if (social_enterprise > 100000) {
                    errorMessages.push('เงินลงทุนธุรกิจ Social Enterprise ไม่ควรเกิน 100,000 บาท');
                    errorFields.push('social_enterprise');
                }
                social_enterprise = Math.min(social_enterprise, 100000);

                let nsf = parseNumber(document.getElementById('nsf').value);
                if (nsf > 13200) {
                    errorMessages.push('เงินสมทบกองทุนการออมแห่งชาติ (กอช.) ไม่ควรเกิน 13,200 บาท');
                    errorFields.push('nsf');
                }
                nsf = Math.min(nsf, 13200);

                // รวมค่าลดหย่อนกลุ่มเกษียณ สูงสุดไม่เกิน 500,000 บาท
                retirement_total = pension_insurance + pvd + rmf + nsf + ssf;
                if (retirement_total > 500000) {
                    errorMessages.push('รวมค่าลดหย่อนกลุ่มเกษียณไม่ควรเกิน 500,000 บาท');
                    errorFields.push('pension_insurance');
                }
                retirement_total = Math.min(retirement_total, 500000);

                // Maximum retirement deduction limit
                max_retirement_deduction = Math.min(500000, total_income * 0.30);

                total_investment_deductions = insurance_total + parent_health_insurance + retirement_total + ssf + thaiesg + social_enterprise;
            } else {
                // Even if the user didn't check 'has_insurance', we need to calculate max retirement deduction
                max_retirement_deduction = Math.min(500000, total_income * 0.30);
            }

            // ค่าลดหย่อนกลุ่มเงินบริจาค
            let total_donation_deductions = 0;
            if (document.getElementById('has_donation').checked) {
                let donation = parseNumber(document.getElementById('donation').value);

                let donation_education = parseNumber(document.getElementById('donation_education').value) * 2;

                let donation_political = parseNumber(document.getElementById('donation_political').value);
                if (donation_political > 10000) {
                    errorMessages.push('เงินบริจาคพรรคการเมืองไม่ควรเกิน 10,000 บาท');
                    errorFields.push('donation_political');
                }
                donation_political = Math.min(donation_political, 10000);

                total_donation_deductions = donation + donation_education + donation_political;
            }

            // ค่าลดหย่อนกลุ่มกระตุ้นเศรษฐกิจของรัฐ
            let total_stimulus_deductions = 0;
            if (document.getElementById('has_stimulus').checked) {
                let easy_ereceipt = parseNumber(document.getElementById('easy_ereceipt').value);
                if (easy_ereceipt > 50000) {
                    errorMessages.push('Easy e-Receipt 2567 ไม่ควรเกิน 50,000 บาท');
                    errorFields.push('easy_ereceipt');
                }
                easy_ereceipt = Math.min(easy_ereceipt, 50000);

                let local_travel = parseNumber(document.getElementById('local_travel').value);
                if (local_travel > 15000) {
                    errorMessages.push('ค่าลดหย่อนเที่ยวเมืองรอง 2567 ไม่ควรเกิน 15,000 บาท');
                    errorFields.push('local_travel');
                }
                local_travel = Math.min(local_travel, 15000);

                let home_loan_interest = parseNumber(document.getElementById('home_loan_interest').value);
                if (home_loan_interest > 100000) {
                    errorMessages.push('ดอกเบี้ยกู้ยืมเพื่อที่อยู่อาศัยไม่ควรเกิน 100,000 บาท');
                    errorFields.push('home_loan_interest');
                }
                home_loan_interest = Math.min(home_loan_interest, 100000);

                let new_home = parseNumber(document.getElementById('new_home').value);
                let new_home_deduction = Math.floor(new_home / 1000000) * 10000;
                if (new_home_deduction > 100000) {
                    errorMessages.push('ค่าสร้างบ้านใหม่ 2567-2568 ไม่ควรเกิน 100,000 บาท');
                    errorFields.push('new_home');
                }
                new_home_deduction = Math.min(new_home_deduction, 100000);

                total_stimulus_deductions = easy_ereceipt + local_travel + home_loan_interest + new_home_deduction;
            }

            // ถ้ามีข้อผิดพลาด แสดง Modal และหยุดการทำงาน
            if (errorMessages.length > 0) {
                showErrorModal(errorMessages, errorFields);
                return; // หยุดการทำงานต่อ
            }

            // รวมค่าลดหย่อนทั้งหมด
            let total_deductions = expense + total_personal_deductions + total_investment_deductions + total_stimulus_deductions;

            // เงินได้หลังหักลดหย่อนเบื้องต้น
            let taxable_income = total_income - total_deductions;
            if (taxable_income < 0) taxable_income = 0;

            // คำนวณค่าลดหย่อนเงินบริจาค (ไม่เกิน 10% ของเงินได้หลังหักลดหย่อน)
            if (document.getElementById('has_donation').checked) {
                let donation_limit = taxable_income * 0.10;
                if (total_donation_deductions > donation_limit) {
                    total_donation_deductions = donation_limit;
                }
            }

            total_deductions += total_donation_deductions;

            // เงินได้สุทธิ
            let net_income = total_income - total_deductions;
            if (net_income < 0) net_income = 0;

            // คำนวณภาษี
            let tax = 0;
            if (net_income <= 150000) {
                tax = 0;
            } else if (net_income <= 300000) {
                tax = (net_income - 150000) * 0.05;
            } else if (net_income <= 500000) {
                tax = ((net_income - 300000) * 0.10) + 7500;
            } else if (net_income <= 750000) {
                tax = ((net_income - 500000) * 0.15) + 27500;
            } else if (net_income <= 1000000) {
                tax = ((net_income - 750000) * 0.20) + 65000;
            } else if (net_income <= 2000000) {
                tax = ((net_income - 1000000) * 0.25) + 115000;
            } else if (net_income <= 5000000) {
                tax = ((net_income - 2000000) * 0.30) + 365000;
            } else {
                tax = ((net_income - 5000000) * 0.35) + 1265000;
            }

            // คำนวณอัตราภาษีที่แท้จริง
            let effective_tax_rate = 0;
            if (total_income > 0) {
                effective_tax_rate = (tax / total_income) * 100;
            }

            // คำนวณเปอร์เซ็นต์การใช้สิทธิลดหย่อนกลุ่มเกษียณ
            let retirement_deduction_used = retirement_total;
            let retirement_deduction_percentage = 0;
            if (max_retirement_deduction > 0) {
                retirement_deduction_percentage = (retirement_deduction_used / max_retirement_deduction) * 100;
                if (retirement_deduction_percentage > 100) retirement_deduction_percentage = 100;
            }

            // แสดงผลใน Result Section
            document.getElementById('result_total_income').innerText = formatNumber(total_income);
            document.getElementById('result_expense').innerText = formatNumber(expense);
            document.getElementById('result_deductions').innerText = formatNumber(total_deductions - expense);
            document.getElementById('result_net_income').innerText = formatNumber(net_income);
            document.getElementById('result_tax').innerText = formatNumber(tax) + ' บาท';
            // แสดงอัตราภาษีที่แท้จริง
            document.getElementById('result_effective_tax_rate').innerText = effective_tax_rate.toFixed(2) + '%';

            // อัพเดต Gauge
            let gaugeFill = document.getElementById('gauge_fill');
            gaugeFill.style.width = retirement_deduction_percentage + '%';
            gaugeFill.innerText = retirement_deduction_percentage.toFixed(2) + '%';

            // ตรวจสอบว่าผู้ใช้สามารถลดหย่อนได้เพิ่มหรือไม่
            let investmentButton = document.getElementById('investment_button');
            if (retirement_deduction_percentage < 100) {
                investmentButton.style.display = 'block';
            } else {
                investmentButton.style.display = 'none';
            }

            // แสดง Result Section และซ่อนขั้นตอนอื่น ๆ
            document.getElementById('step-3').classList.remove('active');
            document.getElementById('result-section').style.display = 'block';
            window.scrollTo(0, 0);
        }

        // ฟังก์ชันสำหรับแสดง Modal ข้อผิดพลาด
        function showErrorModal(messages, fields) {
            const errorModal = document.getElementById('errorModal');
            const errorList = document.getElementById('errorList');
            errorList.innerHTML = '';
            messages.forEach(function(msg) {
                const li = document.createElement('li');
                li.innerText = msg;
                errorList.appendChild(li);
            });
            errorModal.style.display = 'block';

            // เก็บข้อมูล fields ที่มีข้อผิดพลาด
            errorModal.errorFields = fields;
        }

        // ฟังก์ชันสำหรับปิด Modal ข้อผิดพลาด
        function closeErrorModal() {
            const errorModal = document.getElementById('errorModal');
            errorModal.style.display = 'none';

            // เลื่อนไปยัง field ที่มีข้อผิดพลาดแรก
            if (errorModal.errorFields && errorModal.errorFields.length > 0) {
                const firstErrorField = document.getElementById(errorModal.errorFields[0]);
                if (firstErrorField) {
                    firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstErrorField.focus();
                }
            }
        }

        // ฟังก์ชันสำหรับแก้ไขข้อมูล
        function editData() {
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('step-1').classList.add('active');
            window.scrollTo(0, 0);
        }

        // ฟังก์ชันสำหรับเริ่มใหม่
        function resetData() {
            location.reload();
        }

        // ฟังก์ชันสำหรับไปยังส่วนการลงทุน
        function goToInvestmentSection() {
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('step-3').classList.add('active');
            window.scrollTo(0, 0);

            // เปิดส่วนค่าลดหย่อนการลงทุน
            if (!document.getElementById('has_insurance').checked) {
                document.getElementById('has_insurance').checked = true;
                document.getElementById('insurance_section').style.display = 'block';
            }

            // เลื่อนไปยังช่องกรอก SSF
            const ssfField = document.getElementById('ssf');
            if (ssfField) {
                ssfField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                ssfField.focus();
            }
        }
    </script>

</body>
</html>
